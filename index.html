<!DOCTYPE html>
<html>

<head>
  <title>Revision App</title>
  <link rel="stylesheet" href="styleslogin.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

</head>

<body>


  <div>
    <form class='user-forms'>
      <label for='Username'>Username</label><br>
      <input type='text' id='Username' username=username><br>
      <label for='Password'>Password</label><br>
      <input type='text' id='Password' password=password><br>

      <button type="button" id='btnSubmit'>Submit</button>
      <div id='statusMessage' class='status-message'></div>

      <div>
      <button href='signup.html'>Sign Up</button>
        </div>


    </form>
  </div>

  <script>

    //The supabase url
    const supabase_url = 'https://pxjndwrkafegopsolnde.supabase.co'
    //Supabase key
    const supabase_key = 'sb_publishable_eOUJ3K3GNczOncszRwYhyA_A1QAw72F'
    //Initialize supabase client
    const supabaseClient = supabase.createClient(
      'https://pxjndwrkafegopsolnde.supabase.co',
      'sb_publishable_eOUJ3K3GNczOncszRwYhyA_A1QAw72F'
    );


    //fetch the data from the username field
    let usernameElement = document.getElementById('Username');
    let passwordElement = document.getElementById('Password');

    //get the status element
    let statusElement = document.getElementById('statusMessage')

    //Update the status message
    function updateStatus(message) {
    statusElement.textContent = message;
    
    }
    

    //function to check if username is in database
    async function checkCredentials() {
      //Fetches from the table username
      //if not found returns not found to the console
      const { data, error } = await supabaseClient
        //Sql query to fetch username
        .from('userinfo')
        .select('username, password_hash')
        .eq('username', usernameElement.value)



      //Log the query to the console
      console.log('Query:', { data, error })
      //Checks if data array if empty
      if (error || !data || data.length === 0) {
        updateStatus('Username not found')
      }


      //If there are no errors and the array is not 0, then it goes to the else statement  
      else {

        //Checks if the Row with the username passwords matches the password entered
        //Made it so it checks the hash function of the password
        hashedPassword = hash(passwordElement.value)
        if (data[0].password_hash === hashedPassword) {
          updateStatus('Login Succesful')
          //Store users information in sessions storage
          sessionStorage.setItem('currentUser',data[0].username);
          
          //Make page redirect to the main page after login is successful
          setTimeout(() => {
            window.location.href = 'main.html'
        //added a delay to allow the user to have time to see the message before redirecting.    
        },1500)
        }
        else {
          updateStatus('Password Incorrect')
        }
      }

    };

//This is the function to hash the password of the user
 function hash(password) {
   let product = 1;
   //iterates through string
   for(let i = 0; i < password.length; i++) {
     // mutiplies product by the code
     product *= password.charCodeAt(i);
   }
   return product
 }



    
    document.addEventListener('DOMContentLoaded', function () {
      //Get the element of the submit button   
      let button = document.getElementById('btnSubmit');
      // Add event listener to the button
      button.addEventListener('click', function () {

        //log the value of the username form to the console
        console.log(usernameElement.value);
        checkCredentials()
      });


    });


  </script>
</body>

</html>
